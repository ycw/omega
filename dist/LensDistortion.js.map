{"version":3,"file":"LensDistortion.js","sources":["../src/LensDistortion/LensDistortionShader.ts","../src/LensDistortion/LensDistortionPass.ts"],"sourcesContent":["export const LensDistortionShader = {\r\n  uniforms: {\r\n    'tDiffuse': { value: null },\r\n    'uK0': { value: null }, // radial distortion coeff 0\r\n    'uCc': { value: null }, // principal point\r\n    'uFc': { value: null },  // focal length\r\n    'uAlpha_c': { value: 0 }, // skew coeff\r\n  },\r\n  vertexShader: /* glsl */ `\r\n    varying vec2 vUv;\r\n    void main() {\r\n      vUv = uv;\r\n      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r\n  }`,\r\n  fragmentShader: /* glsl */ `\r\n    uniform sampler2D tDiffuse;\r\n    uniform vec2 uK0;\r\n    uniform vec2 uCc; \r\n    uniform vec2 uFc; \r\n    uniform float uAlpha_c;\r\n    varying vec2 vUv;\r\n    void main() {\r\n      vec2 Xn = 2. * ( vUv.st - .5 ); // -1..1\r\n      vec3 Xd = vec3(( 1. + uK0 * dot( Xn, Xn ) ) * Xn, 1.); // distorted \r\n      mat3 KK = mat3(\r\n        vec3(uFc.x, 0., 0.),\r\n        vec3(uAlpha_c * uFc.x, uFc.y, 0.),\r\n        vec3(uCc.x, uCc.y, 1.)\r\n      );\r\n      vec2 Xp = ( KK * Xd ).xy * .5 + .5; // projected; into 0..1 \r\n      if ( Xp.x >= 0. && Xp.x <= 1. && Xp.y >= 0. && Xp.y <= 1. ) {\r\n        gl_FragColor = texture2D( tDiffuse, Xp );\r\n      }\r\n    }\r\n  `\r\n};","import { ShaderMaterial, Vector2, UniformsUtils, WebGLRenderer, WebGLRenderTarget } from 'three';\r\nimport { Pass, FullScreenQuad } from 'three/examples/jsm/postprocessing/Pass.js';\r\nimport { LensDistortionShader } from './LensDistortionShader';\r\n\r\nexport class LensDistortionPass extends Pass {\r\n\r\n  #fsQuad: FullScreenQuad;\r\n  #uniforms: ShaderMaterial['uniforms'];\r\n\r\n  constructor({\r\n    distortion = new Vector2(0, 0),\r\n    principalPoint = new Vector2(0, 0),\r\n    focalLength = new Vector2(1, 1),\r\n    skew = 0,\r\n  } = {}) {\r\n    super();\r\n\r\n    this.#fsQuad = new FullScreenQuad(new ShaderMaterial({\r\n      uniforms: UniformsUtils.clone(LensDistortionShader.uniforms),\r\n      vertexShader: LensDistortionShader.vertexShader,\r\n      fragmentShader: LensDistortionShader.fragmentShader,\r\n    }));\r\n\r\n    const mat = this.#fsQuad.material as ShaderMaterial;\r\n    mat.uniforms['uK0'].value = distortion; // radial distortion coeff of term r^2\r\n    mat.uniforms['uCc'].value = principalPoint;\r\n    mat.uniforms['uFc'].value = focalLength;\r\n    mat.uniforms['uAlpha_c'].value = skew;\r\n\r\n    this.#uniforms = mat.uniforms;\r\n  }\r\n\r\n  render(\r\n    renderer: WebGLRenderer,\r\n    writeBuffer: WebGLRenderTarget,\r\n    readBuffer: WebGLRenderTarget\r\n  ) {\r\n    this.#uniforms['tDiffuse'].value = readBuffer.texture;\r\n    if (this.renderToScreen) {\r\n      renderer.setRenderTarget(null);\r\n    } else {\r\n      renderer.setRenderTarget(writeBuffer);\r\n      if (this.clear) renderer.clear();\r\n    }\r\n    this.#fsQuad.render(renderer);\r\n  }\r\n\r\n  get distortion() { return this.#uniforms['uK0'].value }\r\n  set distortion(value) { this.#uniforms['uK0'].value = value }\r\n\r\n  get principalPoint() { return this.#uniforms['uCc'].value }\r\n  set principalPoint(value) { this.#uniforms['uCc'].value = value }\r\n\r\n  get focalLength() { return this.#uniforms['uFc'].value }\r\n  set focalLength(value) { this.#uniforms['uFc'].value = value }\r\n\r\n  get skew() { return this.#uniforms['uAlpha_c'].value }\r\n  set skew(value) { this.#uniforms['uAlpha_c'].value = value }\r\n};"],"names":["LensDistortionShader","uniforms","tDiffuse","value","uK0","uCc","uFc","uAlpha_c","vertexShader","fragmentShader","LensDistortionPass","Pass","fsQuad","constructor","distortion","Vector2","principalPoint","focalLength","skew","super","this","FullScreenQuad","ShaderMaterial","UniformsUtils","clone","mat","material","render","renderer","writeBuffer","readBuffer","texture","renderToScreen","setRenderTarget","clear"],"mappings":"kKAAaA,EAAuB,CAClCC,SAAU,CACRC,SAAY,CAAEC,MAAO,MACrBC,IAAO,CAAED,MAAO,MAChBE,IAAO,CAAEF,MAAO,MAChBG,IAAO,CAAEH,MAAO,MAChBI,SAAY,CAAEJ,MAAO,IAEvBK,aAAyB,oJAMzBC,eAA2B,gpBCVhBC,UAA2BC,EAEtCC,GACAX,GAEAY,aAAYC,WACVA,EAAa,IAAIC,EAAQ,EAAG,GAAEC,eAC9BA,EAAiB,IAAID,EAAQ,EAAG,GAAEE,YAClCA,EAAc,IAAIF,EAAQ,EAAG,GAAEG,KAC/BA,EAAO,GACL,IACFC,QAEAC,MAAKR,EAAU,IAAIS,EAAe,IAAIC,EAAe,CACnDrB,SAAUsB,EAAcC,MAAMxB,EAAqBC,UACnDO,aAAcR,EAAqBQ,aACnCC,eAAgBT,EAAqBS,kBAGvC,MAAMgB,EAAML,MAAKR,EAAQc,SACzBD,EAAIxB,SAAc,IAAEE,MAAQW,EAC5BW,EAAIxB,SAAc,IAAEE,MAAQa,EAC5BS,EAAIxB,SAAc,IAAEE,MAAQc,EAC5BQ,EAAIxB,SAAmB,SAAEE,MAAQe,EAEjCE,MAAKnB,EAAYwB,EAAIxB,SAGvB0B,OACEC,EACAC,EACAC,GAEAV,MAAKnB,EAAoB,SAAEE,MAAQ2B,EAAWC,QAC1CX,KAAKY,eACPJ,EAASK,gBAAgB,OAEzBL,EAASK,gBAAgBJ,GACrBT,KAAKc,OAAON,EAASM,SAE3Bd,MAAKR,EAAQe,OAAOC,GAGlBd,iBAAe,OAAOM,MAAKnB,EAAe,IAAEE,MAC5CW,eAAWX,GAASiB,MAAKnB,EAAe,IAAEE,MAAQA,EAElDa,qBAAmB,OAAOI,MAAKnB,EAAe,IAAEE,MAChDa,mBAAeb,GAASiB,MAAKnB,EAAe,IAAEE,MAAQA,EAEtDc,kBAAgB,OAAOG,MAAKnB,EAAe,IAAEE,MAC7Cc,gBAAYd,GAASiB,MAAKnB,EAAe,IAAEE,MAAQA,EAEnDe,WAAS,OAAOE,MAAKnB,EAAoB,SAAEE,MAC3Ce,SAAKf,GAASiB,MAAKnB,EAAoB,SAAEE,MAAQA"}