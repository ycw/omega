import{Matrix4 as t,Vector3 as n,Vector2 as o,BufferGeometry as e,Mesh as r,Uint16BufferAttribute as i,Uint32BufferAttribute as s,BufferAttribute as l}from"three";function a(t,n,o,e){if("a"===o&&!e)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof n?t!==n||!e:!n.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===o?e:"a"===o?e.call(t):e?e.value:n.get(t)}function h(){this.polygons=[]}var c;h.fromPolygons=function(t){var n=new h;return n.polygons=t,n},h.prototype={clone:function(){var t=new h;return t.polygons=this.polygons.map((function(t){return t.clone()})),t},toPolygons:function(){return this.polygons},union:function(t){var n=new h.Node(this.clone().polygons),o=new h.Node(t.clone().polygons);return n.clipTo(o),o.clipTo(n),o.invert(),o.clipTo(n),o.invert(),n.build(o.allPolygons()),h.fromPolygons(n.allPolygons())},subtract:function(t){var n=new h.Node(this.clone().polygons),o=new h.Node(t.clone().polygons);return n.invert(),n.clipTo(o),o.clipTo(n),o.invert(),o.clipTo(n),o.invert(),n.build(o.allPolygons()),n.invert(),h.fromPolygons(n.allPolygons())},intersect:function(t){var n=new h.Node(this.clone().polygons),o=new h.Node(t.clone().polygons);return n.invert(),o.clipTo(n),o.invert(),n.clipTo(o),o.clipTo(n),n.build(o.allPolygons()),n.invert(),h.fromPolygons(n.allPolygons())},inverse:function(){var t=this.clone();return t.polygons.map((function(t){t.flip()})),t}},h.Vector=function(t,n,o){3==arguments.length?(this.x=t,this.y=n,this.z=o):"x"in t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t[0],this.y=t[1],this.z=t[2])},h.Vector.prototype={clone:function(){return new h.Vector(this.x,this.y,this.z)},negated:function(){return new h.Vector(-this.x,-this.y,-this.z)},plus:function(t){return new h.Vector(this.x+t.x,this.y+t.y,this.z+t.z)},minus:function(t){return new h.Vector(this.x-t.x,this.y-t.y,this.z-t.z)},times:function(t){return new h.Vector(this.x*t,this.y*t,this.z*t)},dividedBy:function(t){return new h.Vector(this.x/t,this.y/t,this.z/t)},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lerp:function(t,n){return this.plus(t.minus(this).times(n))},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.dividedBy(this.length())},cross:function(t){return new h.Vector(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}},h.Vertex=function(t,n,o,e){this.pos=new h.Vector(t),this.normal=n&&new h.Vector(n),this.uv=o&&o.clone(),this.color=e&&new h.Vector(e)},h.Vertex.prototype={clone:function(){return new h.Vertex(this.pos.clone(),this.normal&&this.normal.clone(),this.uv&&this.uv.clone(),this.color&&this.color.clone())},flip:function(){this.normal&&(this.normal=this.normal.negated())},interpolate:function(t,n){return new h.Vertex(this.pos.lerp(t.pos,n),this.normal&&t.normal&&this.normal.lerp(t.normal,n),this.uv&&t.uv&&this.uv.clone().lerp(t.uv,n),this.color&&t.color&&this.color.lerp(t.color,n))}},h.Plane=function(t,n){this.normal=t,this.w=n},h.Plane.EPSILON=1e-5,h.Plane.fromPoints=function(t,n,o){var e=n.minus(t).cross(o.minus(t)).unit();return new h.Plane(e,e.dot(t))},h.Plane.prototype={clone:function(){return new h.Plane(this.normal.clone(),this.w)},flip:function(){this.normal=this.normal.negated(),this.w=-this.w},splitPolygon:function(t,n,o,e,r){for(var i=0,s=[],l=0;l<t.vertices.length;l++){var a=(m=this.normal.dot(t.vertices[l].pos)-this.w)<-h.Plane.EPSILON?2:m>h.Plane.EPSILON?1:0;i|=a,s.push(a)}switch(i){case 0:(this.normal.dot(t.plane.normal)>0?n:o).push(t);break;case 1:e.push(t);break;case 2:r.push(t);break;case 3:var c=[],u=[];for(l=0;l<t.vertices.length;l++){var p=(l+1)%t.vertices.length,f=s[l],y=s[p],g=t.vertices[l],w=t.vertices[p];if(2!=f&&c.push(g),1!=f&&u.push(2!=f?g.clone():g),3==(f|y)){var m=(this.w-this.normal.dot(g.pos))/this.normal.dot(w.pos.minus(g.pos)),v=g.interpolate(w,m);c.push(v),u.push(v.clone())}}c.length>=3&&e.push(new h.Polygon(c,t.shared)),u.length>=3&&r.push(new h.Polygon(u,t.shared))}}},h.Polygon=function(t,n){this.vertices=t,this.shared=n,this.plane=h.Plane.fromPoints(t[0].pos,t[1].pos,t[2].pos)},h.Polygon.prototype={clone:function(){var t=this.vertices.map((function(t){return t.clone()}));return new h.Polygon(t,this.shared)},flip:function(){this.vertices.reverse().map((function(t){t.flip()})),this.plane.flip()}},h.Node=function(t){this.plane=null,this.front=null,this.back=null,this.polygons=[],t&&this.build(t)},h.Node.prototype={clone:function(){var t=new h.Node;return t.plane=this.plane&&this.plane.clone(),t.front=this.front&&this.front.clone(),t.back=this.back&&this.back.clone(),t.polygons=this.polygons.map((function(t){return t.clone()})),t},invert:function(){for(var t=0;t<this.polygons.length;t++)this.polygons[t].flip();this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();var n=this.front;this.front=this.back,this.back=n},clipPolygons:function(t){if(!this.plane)return t.slice();for(var n=[],o=[],e=0;e<t.length;e++)this.plane.splitPolygon(t[e],n,o,n,o);return this.front&&(n=this.front.clipPolygons(n)),o=this.back?this.back.clipPolygons(o):[],n.concat(o)},clipTo:function(t){this.polygons=t.clipPolygons(this.polygons),this.front&&this.front.clipTo(t),this.back&&this.back.clipTo(t)},allPolygons:function(){var t=this.polygons.slice();return this.front&&(t=t.concat(this.front.allPolygons())),this.back&&(t=t.concat(this.back.allPolygons())),t},build:function(t){if(t.length){this.plane||(this.plane=t[0].plane.clone());for(var n=[],o=[],e=0;e<t.length;e++)this.plane.splitPolygon(t[e],this.polygons,this.polygons,n,o);n.length&&(this.front||(this.front=new h.Node),this.front.build(n)),o.length&&(this.back||(this.back=new h.Node),this.back.build(o))}}};class u{constructor(t){c.set(this,void 0),function(t,n,o,e,r){if("m"===e)throw new TypeError("Private method is not writable");if("a"===e&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof n?t!==n||!r:!n.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===e?r.call(t,o):r?r.value=o:n.set(t,o)}(this,c,t instanceof h?t:f(t),"f")}subtract(t){return new u(a(this,c,"f").subtract(t instanceof u?a(t,c,"f"):f(t)))}intersect(t){return new u(a(this,c,"f").intersect(t instanceof u?a(t,c,"f"):f(t)))}union(t){return new u(a(this,c,"f").union(t instanceof u?a(t,c,"f"):f(t)))}toMesh(){return function(t){const n=t.toPolygons(),o=new Map;let a=0;for(const{vertices:t,shared:e}of n)o.has(e)?o.get(e).push(t):o.set(e,[t]),a+=t.length;const h=new Float32Array(3*a),c=new Float32Array(3*a),u=new Float32Array(2*a),p=new Float32Array(3*a),f=new e,y=[],g=new r(f,y);let w,m,v,d=0,P=0,b=0,x=0,k=0,z=0,T=0;const V=[];let A=0;for(const[t,n]of o.entries()){P=0;for(const t of n){for(let n=1,o=t.length-1;n<o;++n)V.push(A,A+n,A+n+1);A+=t.length,P+=3*(t.length-2);for(const{pos:n,normal:o,uv:e,color:r}of t)h[x++]=n.x,h[x++]=n.y,h[x++]=n.z,w||(w=o),o?(c[k++]=o.x,c[k++]=o.y,c[k++]=o.z):k+=3,m||(m=e),e?(u[z++]=e.x,u[z++]=e.y):z+=2,v||(v=r),r?(p[T++]=r.x,p[T++]=r.y,p[T++]=r.z):T+=3}y.push(t),f.addGroup(d,P,b),d+=P,b+=1}A<=65535?f.index=new i(V,1):(console.warn("index > 65535"),f.index=new s(V,1));f.setAttribute("position",new l(h,3)),w&&f.setAttribute("normal",new l(c,3));m&&f.setAttribute("uv",new l(u,2));v&&f.setAttribute("color",new l(p,3));return g}(a(this,c,"f"))}}function p(t){return new u(t)}function f(e){return h.fromPolygons(function(e){const r=e.clone();r.updateMatrix();const{matrix:i}=r,s=!i.equals(new t),l=[],a=e.geometry.attributes.position.array,{normal:c,uv:u,color:p}=e.geometry.attributes,f=c&&c.array,y=u&&u.array,g=p&&p.array,w=e.geometry.index&&e.geometry.index.array,m=w?w.length:a.length/3,v=Array.isArray(e.material)?e.geometry.groups:[{start:0,count:m,materialIndex:0}];for(const{start:t,count:r,materialIndex:c}of v){const u=Array.isArray(e.material)?e.material[c??0]:e.material;for(let e=t;e<t+r;e+=3){const t=[];for(let r=0;r<3;++r){const l=w?w[e+r]:e+r;t.push(new h.Vertex(s?(new n).fromArray(a,3*l).applyMatrix4(i):a.subarray(3*l,3*l+3),f&&f.subarray(3*l,3*l+3),y&&(new o).fromArray(y,2*l),g&&g.subarray(3*l,3*l+3)))}l.push(new h.Polygon(t,u))}}return l}(e))}c=new WeakMap;export{p as CSG};
//# sourceMappingURL=CSG.js.map
